function WindowSpeechEngine(){let e=this;function r(r,n,o){if(r&&""!==r.trim()&&voices.freeVoices&&(!voices.freeVoices||0!==Object.keys(voices.freeVoices).length))return t().then((()=>new Promise((t=>{e.utterThis=new SpeechSynthesisUtterance,e.utterThis.text=r;let a="";reader.previewVoiceKey?(a=reader.previewVoiceKey,reader.previewVoiceKey=""):a=readingBar.settings.selectedVoice;let i=a.split(" ");i.pop(),a=i.join(" ")+" free",e.utterThis.voice=voices.freeVoices[a].voice,e.utterThis.volume=parseFloat(readingBar.settings.volume),e.utterThis.rate=utils.calculateRate(readingBar.settings.speed,voices.allVoices[a]),e.onEvent=o,function(r,t){e.utterThis.onend=()=>{e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef),e.onEvent&&e.onEvent({type:"end"})},e.utterThis.onerror=()=>{e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef)},e.utterThis.onstart=()=>{e.onEvent&&e.onEvent({type:"start"})};let n=0;e.utterThis.onboundary=o=>{if("word"==o.name&&(void 0!==o.charLength||void 0!==o.length)){let a=t.substr(o.charIndex,o.charLength||o.length);e.onEvent&&e.onEvent({type:"word",word:a,wordIndex:n,index:r}),n++}}}(n,r),t(voices.allVoices[a])})))).then((r=>{e.synth.speak(e.utterThis),"google"===r.source&&(e.resumeIntervalRef=setInterval((()=>{e.synth.speaking?(e.synth.pause(),e.synth.resume()):clearInterval(e.resumeIntervalRef)}),5e3))})).catch((e=>{}));o({type:"end"})}function t(){return new Promise((r=>{e.resumeIntervalRef&&(clearInterval(e.resumeIntervalRef),e.resumeIntervalRef=null),e.utterThis&&(e.utterThis.onend=null,e.utterThis.onboundary=null,e.utterThis.onerror=null,e.utterThis=null),e.synth.cancel(),r()}))}e.type="free",e.synth=window.speechSynthesis,e.utterThis=null,e.playTimeoutRef=null,e.isStoppedWhenProcessingPlay=!1,e.isProcessingPlay=!1,e.play=r,e.pause=function(r=!0){e.stop(r)},e.stop=function(r=!0){e.onEvent&&r&&e.onEvent({type:"pause"});return e.synth.paused?Promise.resolve().then((()=>new Promise((r=>{e.synth.resume(),r()})))).then((()=>t())).catch((function(e){})):t()},e.resume=function(e,t){r(e,t,!1)},e.onEvent=null,e.resumeIntervalRef=null}function ChromeTtsEngine(){let e=this;e.init=function(){},e.type="free",e.play=function(n,o,a){if(!n||""===n.trim()||!voices.freeVoices||voices.freeVoices&&0===Object.keys(voices.freeVoices).length)return void a({type:"end"});return t().then((function(t){e.onEvent=a,r=0;let i="";reader.previewVoiceKey?(i=reader.previewVoiceKey,reader.previewVoiceKey=""):i=readingBar.settings.selectedVoice;let s=voices.allVoices[i].voice.name||voices.allVoices[i].voice.voiceName,l=utils.calculateRate(readingBar.settings.speed,voices.allVoices[i]),c=parseFloat(readingBar.settings.volume);setTimeout((()=>{browser.tts.speak(n,{voiceName:s,rate:l,volume:c,requiredEventTypes:["start","end","word"],desiredEventTypes:["start","end","error","interrupted","word"],onEvent:t=>{!function(t,n,o){if("start"==t.type)e.onEvent&&e.onEvent({type:"start"});else if("end"==t.type)e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef),e.onEvent&&e.onEvent({type:"end"});else if("error"==t.type)e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef);else if("word"==t.type&&(void 0!==t.charLength||void 0!==t.length)){let a=n.substr(t.charIndex,t.charLength||t.length);e.onEvent&&(e.onEvent&&e.onEvent({type:"word",word:a,wordIndex:r,index:o}),r++)}}(t,n,o)}}),"google"===voices.allVoices[i].source&&(e.resumeIntervalRef=setInterval((()=>{browser.tts.isSpeaking((function(r){r?(browser.tts.pause(),browser.tts.resume()):clearInterval(e.resumeIntervalRef)}))}),5e3))}),0)})).catch((e=>{}))},e.stop=function(r=!0){e.onEvent&&r&&e.onEvent({type:"pause"});browser.tts.stop()},e.pause=function(r=!0){e.stop(r)},e.onEvent=null,e.stopIfAlreadySpeaking=t,e.resumeIntervalRef=null;let r=0;function t(){return new Promise((function(r){e.resumeIntervalRef&&(clearInterval(e.resumeIntervalRef),e.resumeIntervalRef=null),browser.tts.isSpeaking((function(e){e&&browser.tts.stop(),r({isSpeaking:e})}))}))}}const freeTts=new WindowSpeechEngine;function OnlineTtsEngine(){class e{constructor(e,r,t,n){}}let r=this;function t(){"undefined"!=typeof readingBar&&(r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetPlaybackRate",tabId:r.playerTabId,rate:utils.calculateRate(readingBar.settings.speed)}):r.audioPlayer.playbackRate=utils.calculateRate(readingBar.settings.speed))}function n(){return new Promise((e=>{r.playTimeoutRef&&clearTimeout(r.playTimeoutRef),r.wordMarkTimer&&clearInterval(r.wordMarkTimer),r.onEvent=null,r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerClearPlay"},(()=>{e()})):(r.playPromise&&r.playPromise.then((()=>{r.audioPlayer.pause()})).catch((e=>{})),e())})).catch((e=>{}))}async function o(e,t,n){try{if(!e||!e||""===e.trim())return void(r.onEvent&&r.onEvent({type:"end"}));{let i=null!==t?t+"":readingBar.settings.selectedVoice+"_"+readingBar.settings.speed,s=null!==t?r.preloads[i]:r.previews[i];if(!s)return r.onEvent&&r.onEvent({type:"loading"}),c(e).then((o=>{r.preloads[i]={text:e,blob:o,index:t},a(r.preloads[i],n)})).catch((function(e){}));if(n!==r.playId)throw new Error("invalid playid");try{s.blob.isPending()&&r.onEvent&&r.onEvent({type:"loading"})}catch(e){}(await s.blob).text===e?a(s,n):(l(t),o(e,t,n))}}catch(e){}}async function a(e,n){try{if(n!==r.playId||!e)throw new Error("invalid playId");let a=await e.blob;a.err&&""!==a.err?(o=a.err,r.errCount++,r.errCount>=3||!u(o)?(r.hasError=!0,r.setNumPreloads(2,0),r.onEvent&&r.onEvent({type:"error",err:o,isTempError:u(o)})):(function(e){return 1002===e||1e3===e}(o)&&r.errCount>0&&r.errCount--,r.onEvent&&r.onEvent({type:"end"}))):(r.hasError&&(r.hasError=!1,r.hasInvalidLicenseError=!1,r.invalidLicenseErrorCount=0,r.isStoppedWhenProcessingPlay=!1,r.setNumPreloads(2,4)),async function(e,n){try{let o=null;return r.errCount=0,Promise.resolve().then((async()=>(o=await e.blob,Promise.resolve()))).then((()=>new Promise((e=>{r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetSrc",tabId:r.playerTabId,src:o.url,text:o.text},(()=>{e()})):(r.audioPlayer.src=o.url,e())})))).then((()=>new Promise((e=>{r.currentVoice&&"aca"===r.currentVoice.source?r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetVolume",tabId:r.playerTabId,volume:parseFloat(.5*readingBar.settings.volume)}):r.audioPlayer.volume=parseFloat(.5*readingBar.settings.volume):r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetVolume",tabId:r.playerTabId,volume:parseFloat(readingBar.settings.volume)}):r.audioPlayer.volume=parseFloat(readingBar.settings.volume),e()})))).then((()=>new Promise((e=>{r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerLoad",tabId:r.playerTabId},(()=>{e()})):(r.audioPlayer.load(),e())})))).then((()=>{if(function(){if(r.hasMediaViolation)return chrome.runtime.sendMessage({fn:"playerAddEventListenerToPlayer",tabId:r.playerTabId});r.audioPlayer.onended=()=>{r.onEvent&&r.onEvent({type:"end"})},r.audioPlayer.onplay=()=>{r.onEvent&&r.onEvent({type:"start"})},r.audioPlayer.onerror=()=>{r.onEvent&&r.onEvent({type:"error",err:r.audioPlayer.error.message})}}(),r.isStoppedWhenProcessingPlay)i();else try{if(n!==r.playId||!e)throw new Error("invalid playid");t(),r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerPlay",tabId:r.playerTabId}):r.playPromise=r.audioPlayer.play(),function(e,t,n=""){r.hasMediaViolation?(r.textForMediaViolation=e,r.marksForMediaViolation=t):r.audioPlayer.oncanplay=()=>{try{r.wordMarkTimer&&clearInterval(r.wordMarkTimer);let o=0,a=performance.now(),i=(ttsText.getTextChunks(e),0);if(t&&0===t.length){let t=e.split(" "),o=[],s=0;for(let e=0;e<t.length;e++)t[e]?(o.push(s),s=s+t[e].length+1):s++;let l=0,c=1e3*r.audioPlayer.duration/utils.calculateRate(readingBar.settings.speed),d=c/e.length*.95;r.wordMarkTimer=setInterval((()=>{let s=performance.now();if(i=s-a,i>=c||c<=0||isNaN(r.audioPlayer.duration))return void clearInterval(r.wordMarkTimer);let u=Math.floor(i/d);u>e.length?clearInterval(r.wordMarkTimer):u>=o[l]&&r.onEvent&&"openai"!==n&&r.onEvent({type:"word",word:t[l],wordIndex:l++})}),50)}else{const e=[];for(let r=0;r<t.length;r++)e.push(t[r].time/utils.calculateRate(readingBar.settings.speed));r.wordMarkTimer=setInterval((()=>{let s=performance.now();i=s-a,i>e[o]&&r.onEvent&&"openai"!==n&&(r.onEvent({type:"word",word:t[o].word,wordIndex:o++}),o>=t.length&&clearInterval(r.wordMarkTimer))}),50)}}catch(e){}}}(o.text,o.marks,r.currentVoice.source)}catch(e){}}))}catch(e){}r.isProcessingPlay=!1,r.isStoppedWhenProcessingPlay=!1}(e,n))}catch(o){}var o}function i(e){return r.onEvent&&e&&r.onEvent({type:"pause"}),r.isProcessingPlay&&(r.isStoppedWhenProcessingPlay=!0),n()}async function s(e,t){try{if(t!==r.playId)throw new Error("inavlid playId");let n=e+"";if(r.preloads[n])return;{let t=ttsText.textsForTts[e].processed;if(!t||""===t.trim())return;r.preloads[n]={text:t,blob:p(c(t)),index:e}}}catch(e){}}function l(e){null!==e&&delete r.preloads[e+""]}function c(r,t=null){return new Promise((async(n,o)=>{let a=3,i=new e("","",[],"");for(;a>0;){if(t||(t=voices.getVoice(readingBar.settings.selectedVoice),reader.previewingVoice&&(t=reader.previewingVoice)),t&&"ms-cloned"===t.source&&t.isExpired){let e=await voices.reActivateVoice(t);if("ready"!==e){i.err=e;break}}const e=await d(r,t);e&&e.decrementAttemptCount?(a--,a<=0&&(i=e)):(a=0,i=e)}n(i)})).catch((e=>{}))}function d(e,t=null){return new Promise((n=>{const o=function(e,t){let n="";if(reader.previewVoiceKey&&reader.previewingVoice?(n=reader.previewingVoice,reader.previewingVoice=null,reader.previewVoiceKey=""):n=voices.allVoices[readingBar.settings.selectedVoice],r.ttsEndpoint=r.premTtsEndpoint,"plus"===n.type&&(r.ttsEndpoint=r.plusTtsEndpoint),r.currentVoice=n,!n.id||!n.source)throw new Error("error");let o="",a="";return a=null!==n?"ms-cloned"===n.source?"&c="+n.speakerId+"&s=0&v="+n.source:"&r="+n.id+"&s=0&v="+n.source:"&r=21&s=0&v=aca",t&&t.email?(o+="?e="+t.email,void 0!==t.license&&(o+="&l="+t.license),t.ownerEmail&&(o+="&o="+t.ownerEmail),o+=a):o="?l=0"+a,o+="&vn="+chrome.runtime.getManifest().version+"&sm="+r.isSpeechMark,r.ttsEndpoint+o}(r.ttsEndpoint,readingBar.settings.userInfo);chrome.runtime.sendMessage({fn:"sendTtsRequest",queryEndpoint:o,text:e},(async function(e){const o=await function(e){if(e.url){const r=atob(e.url.split(",")[1]),t=[];for(let e=0;e<r.length;e++)t.push(r.charCodeAt(e));e.url=window.URL.createObjectURL(new Blob([new Uint8Array(t)],{type:"audio/mpeg"}))}return Promise.resolve(e)}(e);return""!==o.err?"ERR_SPEAKER_ID"==o.err||"1009"==o.err?(t&&(t.isExpired=!0),n(o)):("1008"==o.err&&(t.isExpired=!0),function(e){if("ERR_NO_RETRY"==e||"ERR_VOICE_NOT_FOUND"==e||"ERR_VOICE_EXPIRED"==e)return!0}(o.err)||("Too Many Requests"===o.err&&(r.hasTooManyRequestsError=!0),o.decrementAttemptCount=!0),n(o)):n(o)}))})).catch((e=>{}))}function u(e){return 1001!=e&&1003!=e&&1004!=e&&1005!=e&&1006!=e&&"ERR_LICENSE_INVALID"!=e&&"Limit Exceeded"!=e&&"ERR_EMPTY_TEXT"!=e}function p(e){try{if(e.isResolved)return e;let r=!0,t=!1,n=!1,o=e.then((function(e){return n=!0,r=!1,e}),(function(e){throw t=!0,r=!1,e}));return o.isFulfilled=function(){return n},o.isPending=function(){return r},o.isRejected=function(){return t},o}catch(r){return e}}r.type="online",r.ttsEndpoint,r.premTtsEndpoint="https://moxu0s1jnk.execute-api.us-east-1.amazonaws.com/prod-wpm/tts",r.plusTtsEndpoint="https://2poo4vxwjc.execute-api.us-east-1.amazonaws.com/prod-wps/tts",r.audioPlayer=null,r.errCount=0,r.playId=void 0,r.numPreloads={prev:2,next:4},r.preloads={},r.previews={},r.hasError=!1,r.hasTooManyRequestsError=!1,r.onEvent=null,r.wordMarkTimer=null,r.play=async function(e,t,a){r.previousText=e||null;r.playId=Date.now();let i=r.playId;return r.isStoppedWhenProcessingPlay?(r.isProcessingPlay=!1,r.isStoppedWhenProcessingPlay=!1,Promise.resolve()):(await n(),Promise.resolve().then((()=>(r.onEvent=a,o(e,t,i)))).then((()=>{if(null!==t&&i===r.playId)return async function(e,t){let n=voices.getVoice(readingBar.settings.selectedVoice);if(n&&"ms-cloned"===n.source&&n.isExpired)return;let o={};o[e+""]=!0;for(let n=1;n<r.numPreloads.next+1&&!r.isStoppedWhenProcessingPlay;n++)try{let r=await ttsText.getIndexOfNNextSentence(n,e);if(-1===r)break;o[r+""]=!0,s(r,t)}catch(e){continue}for(let t=1;t<r.numPreloads.prev+1&&!r.isStoppedWhenProcessingPlay;t++)try{let r=await ttsText.getIndexOfNPrevSentence(t,e);if(-1===r)break;o[r+""]=!0}catch(e){continue}!function(e){for(let t in r.preloads){let n=r.preloads[t];e[t]||l(n.index)}}(o)}(t,i)})).catch((e=>{})))},r.pause=function(e=!0){r.stop(e)},r.stop=i,r.clearPreloads=function(){r.preloads={}},r.clearBlobsWithError=async function(){for(let e in r.preloads){let t=r.preloads[e],n=await t.blob;"ERR_CONVERT_LIMIT"!==n.err&&1005!=n.err&&1006!==n.err&&"ERR_LICENSE_INVALID"!==n.err||l(t.index)}},r.setNumPreloads=function(e,t){r.numPreloads={prev:e,next:t}},r.previewPlus=function e(n){reader.previewVoiceKey="";let o=voices.formPlusVoiceUrl(n);return new Promise((e=>{r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetSrc",tabId:r.playerTabId,src:o},(()=>{e()})):(r.audioPlayer.src=o,e())})).then((()=>new Promise((e=>{n&&"aca"===n.source?r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetVolume",tabId:r.playerTabId,volume:parseFloat(.5*readingBar.settings.volume)}):r.audioPlayer.volume=parseFloat(.5*readingBar.settings.volume):r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetVolume",tabId:r.playerTabId,volume:parseFloat(readingBar.settings.volume)}):r.audioPlayer.volume=parseFloat(readingBar.settings.volume),e()})))).then((()=>new Promise((async e=>{r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerLoad",tabId:r.playerTabId},(()=>{e()})):(r.audioPlayer.load(),e())})))).then((()=>{t(),r.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerPlay",tabId:r.playerTabId}):r.playPromise=r.audioPlayer.play().then((()=>{})).catch((t=>{t.message.includes("Failed to load because no supported source was found")&&chrome.runtime.sendMessage({fn:"injectPlayer",docType:doc.type},(t=>{chrome.runtime.lastError,r.hasMediaViolation=!0,r.playerTabId=t,e(n)}))}))})).catch((e=>{}))},r.isProcessingPlay=!1,r.isStoppedWhenProcessingPlay=!1,r.playPromise=null,r.hasInvalidLicenseError=!1,r.invalidLicenseErrorCount=0,r.currentVoice=null,r.isSpeechMark=!0,r.hasMediaViolation=!1,r.playerTabId=null,r.playerOnended=function(e,t,n){r.onEvent&&r.onEvent({type:"end"})},r.playerOnplay=function(e,t,n){r.onEvent&&r.onEvent({type:"start"})},r.playerOnerror=function(e,t,n){r.onEvent&&r.onEvent({type:"error",err:e.err})},r.playerOncanplay=function(){let e=r.textForMediaViolation,t=r.marksForMediaViolation;try{r.wordMarkTimer&&clearInterval(r.wordMarkTimer);let n=0,o=performance.now(),a=(ttsText.getTextChunks(e),0);if(t&&0===t.length){let t=e.split(" "),n=[],i=0;for(let e=0;e<t.length;e++)t[e]?(n.push(i),i=i+t[e].length+1):i++;let s=0,l=1e3*r.audioPlayer.duration/utils.calculateRate(readingBar.settings.speed),c=l/e.length*.95;r.wordMarkTimer=setInterval((()=>{let i=performance.now();if(a=i-o,a>=l||l<=0||isNaN(r.audioPlayer.duration))return void clearInterval(r.wordMarkTimer);let d=Math.floor(a/c);d>e.length?clearInterval(r.wordMarkTimer):d>=n[s]&&r.onEvent&&r.onEvent({type:"word",word:t[s],wordIndex:s++})}),50)}else{const e=[];for(let r=0;r<t.length;r++)e.push(t[r].time/utils.calculateRate(readingBar.settings.speed));r.wordMarkTimer=setInterval((()=>{let i=performance.now();a=i-o,a>e[n]&&r.onEvent&&(r.onEvent({type:"word",word:t[n].word,wordIndex:n++}),n>=t.length&&clearInterval(r.wordMarkTimer))}),50)}}catch(e){}},r.textForMediaViolation=null,r.marksForMediaViolation=null,r.previousText=null,r.asyncFunctions=[],r.audioPlayer=document.createElement("AUDIO"),browser.runtime.onMessage.addListener((function(e,t,n){if(r[e.fn]&&(r[e.fn](e,t,n),o=e.fn,r.asyncFunctions.includes(o)))return!0;var o}))}var onlineTts=onlineTts||new OnlineTtsEngine;