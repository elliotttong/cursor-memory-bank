(()=>{var e={ERR_SUB_NOT_FOUND:"Looks like you don't have an active Premium subscription. Please check to see if you already have Plus or an active subscription",ERR_NO_VALID_SRC:"Looks like you don't have an active payment method attached to your account. Please update your card information and try again.",ERR_PAYMENT_FAILED:"There was an issue while charging payment. If the error persists, please update your card information and try again."};chrome.auth=new function(){let n=this;function r(){return extension.activeTabId}function i(e=null){return new Promise((n=>{if(!e)return n();const r={IdToken:new chrome.CognitoIdToken({IdToken:e.idToken.jwtToken}),AccessToken:new chrome.CognitoAccessToken({AccessToken:e.accessToken.jwtToken}),RefreshToken:new chrome.CognitoRefreshToken({RefreshToken:e.refreshToken.token}),ClockDrift:e.clockDrift};let i=new chrome.CognitoUserSession(r);const o={Username:i.getIdToken().payload["cognito:username"],Pool:new chrome.CognitoUserPool({UserPoolId:"us-east-1_cIskjGoJg",ClientId:"2o2ltcq8tnme2fidk35frk2kt4"})};chrome.cognitoUser=new chrome.CognitoUser(o),chrome.cognitoUser.setSignInUserSession(i),n()})).catch((e=>{}))}function o(e=""){chrome.storage.sync.get(["userInfo"],(r=>{let o=r.userInfo&&r.userInfo.id?r.userInfo.id:null;if(o){let t={email:r.userInfo.email,id:o,username:r.userInfo.username,session:r.userInfo.session};return i(t.session).then((()=>("init"==e&&(t.licenseTimestamp=Date.now()),l(t.id,t.username)))).then((e=>{let r=e.license,i=e.pwLicNum?e.pwLicNum.toString():"0",o=e.pwLicCode?e.pwLicCode:"0",s=e.pwLicType?e.pwLicType:"pw";r?(t.licNum=r.licNum,t.license=r.licNum.toString(),t.licCode=r.licCode,t.pwLicNum=i,t.pwLicCode=o,t.pwLicType=s,r.ownerEmail&&(t.ownerEmail=r.ownerEmail)):(t.licNum=0,t.license="0",t.licCode="0",t.pwLicNum="0",t.pwLicCode="0",t.pwLicType="pw"),readingBar.setReadingBarSetting({key:"userInfo",value:t}),chrome.pe.getPeListForUser(readingBar.settings.loggedIn,t),"undefined"!=typeof voiceCloning&&(voiceCloning.clonedVoices=[]);let a=n.currentExtId&&n.currentExtId>0?n.currentExtId:extension.activeTabId;a>0&&chrome.tabs.sendMessage(a,{fn:"setLoggedInUI"},(()=>{chrome.runtime.lastError})),(0!=t.licNum||reader.hasInvalidLicenseError)&&extension.beingReadTabId>0&&chrome.tabs.sendMessage(extension.beingReadTabId,{fn:"clearBlobsWithError"},(()=>{chrome.runtime.lastError}));try{reader.isWaitingForLicense&&reader.onLicenseUpdated()}catch(e){reader.stop()}}))}}))}function t(e){n.isProcessing=!0;let r="";"login"===e?r="https://www.naturalreaders.com/login-service/login?redir=ext-login&dest=ext/loading":"logout"===e?r="https://www.naturalreaders.com/login-service/extension/loggedout":"signup"===e&&(r="https://www.naturalreaders.com/login-service/signup?redir=ext-login&dest=ext/loading"),chrome.tabs.create({url:r,active:!1},(function(r){const i=r.id;let o=0,t=0;n.tabId=i,chrome.tabs.sendMessage(extension.activeTabId,{fn:"calculateScreenCenter",width:400,height:700},(r=>{r&&(r.top&&(t=r.top),r.left&&(o=r.left)),chrome.windows.create({tabId:i,type:"popup",focused:!0,width:400,height:700,left:o,top:t},(function(r){n.windowId=r.id,chrome.windows.onFocusChanged.addListener((function e(i){r.id===i||n.isProcessing||(chrome.windows.remove(r.id,(()=>{chrome.runtime.lastError})),chrome.windows.onFocusChanged.removeListener(e))})),chrome.windows.onRemoved.addListener((function e(r){n.windowId===r&&(n.isProcessing=!1,chrome.windows.onRemoved.removeListener(e))})),chrome.tabs.onUpdated.addListener((function r(i,o){if(i==n.tabId&&"complete"===o.status)return"login"===e?chrome.tabs.sendMessage(i,{fn:"login"},(()=>{chrome.runtime.lastError})):"logout"===e?chrome.tabs.sendMessage(i,{fn:"logout"},(()=>{chrome.runtime.lastError})):"signup"===e&&chrome.tabs.sendMessage(i,{fn:"signup"},(()=>{chrome.runtime.lastError})),void chrome.tabs.onUpdated.removeListener(r)}))}))}))}))}function s(e,r,o){let t,s=r.tab.id;if(e.session&&i(e.session),e&&e.user&&"string"==typeof e.user&&(t=JSON.parse(e.user)),t){let r={};r.email=t.userid,r.id=t.id,r.username=t.username,r.session=e.session,e.alreadyLoggedIn||chrome.tabs.sendMessage(s,{fn:"onAlreadyLoggedIn"},(()=>{chrome.runtime.lastError}));let i=e.license?JSON.parse(e.license):null,a=e.pwLicense?JSON.parse(e.pwLicense):i,c=a?a.num.toString():"0",d=a?a.licCode:"0",u=a?a.type:"pw";if(i&&"0"!=i.num){r.license=i.num.toString(),r.licNum=i.licNum,r.licCode=i.licCode,r.pwLicNum=c,r.pwLicCode=d,r.session=e.session,r.pwLicType=u,i.ownerEmail&&(r.ownerEmail=i.ownerEmail),readingBar.setReadingBarSetting({key:"userInfo",value:r}),readingBar.setReadingBarSetting({key:"loggedIn",value:1}),0!=r.licNum&&extension.beingReadTabId>0&&chrome.tabs.sendMessage(extension.beingReadTabId,{fn:"clearBlobsWithError"},(()=>{chrome.runtime.lastError}));let t=n.currentExtId&&n.currentExtId>0?n.currentExtId:extension.activeTabId;chrome.tabs.sendMessage(t,{fn:"setLoggedInUI"},(()=>{chrome.runtime.lastError})),n.isProcessing=!1,o({ok:!0})}else l(t.id,t.username,t.userid).then((e=>{i=e.license,c=e.pwLicNum?e.pwLicNum.toString():"0",d=e.pwLicCode?e.pwLicCode:"0",u=e.pwLicType?e.pwLicType:"pw",i?(r.licNum=i.licNum,r.license=i.licNum.toString(),r.licCode=i.licCode,r.pwLicNum=c,r.pwLicCode=d,r.pwLicType=u,i.ownerEmail&&(r.ownerEmail=i.ownerEmail)):(r.licNum=0,r.license="0",r.licCode="0",r.pwLicNum="0",r.pwLicCode="0",r.pwLicType="pw",r.session=null),readingBar.setReadingBarSetting({key:"userInfo",value:r}),readingBar.setReadingBarSetting({key:"loggedIn",value:1}),0!=r.licNum&&extension.beingReadTabId>0&&chrome.tabs.sendMessage(extension.beingReadTabId,{fn:"clearBlobsWithError"},(()=>{chrome.runtime.lastError}));let o=n.currentExtId&&n.currentExtId>0?n.currentExtId:extension.activeTabId;chrome.tabs.sendMessage(o,{fn:"setLoggedInUI"},(()=>{chrome.runtime.lastError})),chrome.pe.getPeListForUser(readingBar.settings.loggedIn,readingBar.settings.userInfo),n.isProcessing=!1}))}else chrome.tabs.onUpdated.addListener((function(e,n,r){e===s&&null!=n.url&&(n.url.includes("https://www.naturalreaders.com/login-service/auth-password?email=")&&chrome.tabs.sendMessage(s,{fn:"clearLogin"},(()=>{chrome.runtime.lastError})),n.url.includes("https://www.naturalreaders.com/login-service/extension/loggedin")&&chrome.tabs.sendMessage(s,{fn:"onLogin"},(()=>{chrome.runtime.lastError})))}))}function a(e,r,i){n.isProcessing=!1;readingBar.setReadingBarSetting({key:"userInfo",value:{licNum:0,license:"0",pwLicNum:"0",pwLicCode:"0",email:"user@naturalreaders.com",id:null,username:"",licCode:"0",session:null}}),readingBar.setReadingBarSetting({key:"loggedIn",value:0});let o=n.currentExtId&&n.currentExtId>0?n.currentExtId:extension.activeTabId;chrome.tabs.sendMessage(o,{fn:"setLoggedOutUI"},(()=>{chrome.runtime.lastError})),chrome.pe.setPeAndTts([]),i({ok:!0})}async function c(e,n,r,i){const o={id:e,username:n,provider:r,app:"ext"};let t=new URL("https://rrauikxmbg.execute-api.us-east-1.amazonaws.com/prod/"+i);return t.search=new URLSearchParams(o),fetch(t,{"Content-Type":"application/json"}).then((e=>Promise.resolve(e.json()))).catch((e=>{}))}function l(e,n){return Promise.all([c(e,n,"pw","billing"),c(e,n,"edu","license")]).then((e=>{let n=e[0],r=e[1];if(n){let e=n&&n.planDefine&&!d(n.status)?n.planDefine.licNum:0,i=n&&n.planDefine&&!d(n.status)?n.planDefine.plan:"0",o=n&&n.planDefine&&!d(n.status)?{licNum:n.planDefine.licNum,licCode:n.planDefine.plan}:null,t=n&&n.planDefine&&!d(n.status)?n.app:"pw";"stripe"===t&&(t="pw");let s=r&&r.planDefine?r.planDefine.licNum:0,a=r&&r.planDefine?{licNum:r.planDefine.licNum,licCode:r.planDefine.plan,ownerEmail:r.ownerEmail?r.ownerEmail:""}:null;return(s>=31&&s<=37||s>=40&&s<=42)&&function(){if(readingBar.settings.userInfo&&readingBar.settings.userInfo.email){const e="https://1pakmhwu39.execute-api.us-east-1.amazonaws.com/prod/user",n={email:readingBar.settings.userInfo.email,provider:"edu"},r={"Content-Type":"application/json"};chrome.cognitoUser&&chrome.cognitoUser.getSession((function(i,o){o&&(r.Authorization=o.idToken.jwtToken);let t=new URL(e);return t.search=new URLSearchParams(n),fetch(t,{method:"GET",headers:r}).then((e=>e.json())).catch((e=>{console.error("Error:",e)}))}))}}(),13==e||12==e?{license:o,pwLicNum:e,pwLicCode:i,pwLicType:t}:s>=31&&s<=37||s>=40&&s<=42?{license:a,pwLicNum:e,pwLicCode:i,pwLicType:t}:{license:null,pwLicNum:e,pwLicCode:i,pwLicType:t}}return{license:null,pwLicNum:"0",pwLicCode:"0",pwLicType}})).catch((e=>{}))}function d(e){let n=!0;return n=!1,n}n.windowId=null,n.isProcessing=!1,n.tabId=null,n.currentExtId=-1,n.login=function(e,i,o){n.currentExtId=r(),t("login")},n.signup=function(e,i,o){n.currentExtId=r(),t("signup")},n.logout=function(e,i,o){n.currentExtId=r(),t("logout")},n.signupHelper=function(e,n,r){let i=n.tab.id;chrome.tabs.onUpdated.addListener((function(e,n,r){e===i&&null!=n.url&&(n.url.includes("https://naturalreaders.com/login-service/login?redir=ext-login&dest=ext/loading")&&chrome.tabs.sendMessage(i,{fn:"loginAfterSignup"},(()=>{chrome.runtime.lastError})),n.url.includes("https://www.naturalreaders.com/login-service/extension/loggedin")&&chrome.tabs.sendMessage(i,{fn:"onLogin"},(()=>{chrome.runtime.lastError})))}))},n.loginHelper=s,n.logoutHelper=a,n.updateLicense=o,n.upgrade=function(n,r,i){let o=readingBar.settings.userInfo.pwLicType;if("pw"!==o)alertHandler.displayAlertMessage("UPGRADE_UNSUPPORTED_DIALOG",{licType:o});else{let n=readingBar.settings.userInfo.email,r=readingBar.settings.userInfo.pwLicCode,i="6005";"6006"===r&&(i="6008"),data={liccodeCurr:r,liccodeNew:i,email:n,errors:e},alertHandler.displayAlertMessage("UPGRADE_DIALOG",data)}},function(){chromeRuntimeMsgExternal.setFilter("authLogin",s.bind(this)),chromeRuntimeMsgExternal.setFilter("authLogout",a.bind(this)),chrome.runtime.onMessage.addListener((function(e,n,r){e.fn in chrome.auth&&chrome.auth[e.fn](e,n,r)})),chrome.storage.sync.get(["userInfo"],(e=>{!e||!e.userInfo||e.userInfo&&(!e.userInfo.licenseTimestamp||Date.now()-e.userInfo.licenseTimestamp>864e5)?o("init"):i(e.userInfo.session)}))}()}})();