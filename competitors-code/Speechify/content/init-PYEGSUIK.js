import{a as re}from"./chunk-UPOJKPU4.js";import{n as ne}from"./chunk-LBZ34ZL2.js";import"./chunk-SI7CO4VP.js";import"./chunk-JAWPO7FD.js";import"./chunk-N3ET5YJZ.js";import"./chunk-LXDXREIX.js";import{a as oe}from"./chunk-XP57BQDH.js";import"./chunk-VYK2SFTV.js";import"./chunk-PJRECGUK.js";import{$a as K,_a as B,ab as J,ja as N,la as _}from"./chunk-6VFX2JNU.js";import{k as fe,t as j,x as Z}from"./chunk-LUKOAFYK.js";import"./chunk-O77QQVYU.js";import"./chunk-35EEQS33.js";import{i as be}from"./chunk-BGIN6QNH.js";import"./chunk-UQBFOPQH.js";import{d as D}from"./chunk-6HLOLWYC.js";import"./chunk-XFWXZVUM.js";import"./chunk-D2ACMGPV.js";import{c as ee,g as te}from"./chunk-NORECDYR.js";import{g as pe}from"./chunk-RQERJHUS.js";import{d as q,h as P,j as preactH,l as V,n as ge,o as v}from"./chunk-NUN3A7RC.js";v();P();ge();v();P();var l=q(pe());v();P();var ie=q(fe());var ce=q(be());v();P();var C=e=>{let o=document.querySelector(e.selectors.contentImageSelector)?.getAttribute("src");if(o)return o.match(/blob:https:\/\/[^\s/]+\/([a-zA-Z0-9-]+)/)?.[1]??void 0};function M(e){let t=document.querySelector(e.selectors.locationSelector)?.textContent||"",n=t.includes("Location")?"LOCATION":"PAGE",a=/(\d+)\D+(\d+)/,r=t.match(a);if(r&&r.length===3){let c=parseInt(r[1],10),i=parseInt(r[2],10);return{index:c,total:i,type:n}}return{index:1,total:1,type:n}}var G=e=>{let t=document.createElement("canvas"),o=t.getContext("2d"),n=document.querySelector(e.selectors.contentImageSelector),a=n.getBoundingClientRect(),r=a.x,c=a.y,i=n.naturalWidth,m=n.naturalHeight;t.width=i,t.height=m,o.drawImage(n,0,0);let y=t.toDataURL();re(y,i,m).then(_);let d=y.replace("data:image/png;base64,",""),{index:E,total:h,type:p}=M(e),w=C(e)||"";return{content:d,top:c,left:r,imageUrl:w,isLeftChevronVisible:!!document.getElementById(e.selectors.previousButtonId),isRightChevronVisible:!!document.getElementById(e.selectors.nextButtonId),pageIndex:E,pageType:p,totalPages:h}};var R=(e,t,o,n,a=0)=>{e.dispatchEvent(new MouseEvent(t,{view:window,bubbles:!0,cancelable:!0,clientX:o,clientY:n,button:a}))},ye=e=>{let t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)},W=e=>!e.isTrusted,ae=async(e,t,o,n=0)=>{if(e instanceof HTMLButtonElement&&e.disabled){console.warn("Element is disabled and cannot be clicked.");return}if(!ye(e)){console.warn("Element is not in the viewport.");return}let a=e.getBoundingClientRect(),r=t??a.left+a.width/2,c=o??a.top+a.height/2;return R(e,"mouseover",r,c,n),R(e,"mouseenter",r,c,n),R(e,"focus",r,c,n),R(e,"mousedown",r,c,n),R(e,"mouseup",r,c,n),R(e,"click",r,c,n),new Promise(i=>setTimeout(i,0))},Q=async e=>{let t=document.getElementById(e.selectors.nextButtonId);if(t){let o=C(e);await ae(t),await se(e,o);return}return D(new Error("Next button not found"))},Y=async e=>{let t=document.getElementById(e.selectors.previousButtonId);if(t){let o=C(e);await ae(t),await se(e,o);return}return D(new Error("Previous button not found"))};function se(e,t){return new Promise(o=>{let n=setTimeout(()=>{o()},250),a=()=>{C(e)===t?requestAnimationFrame(a):(clearTimeout(n),o())};requestAnimationFrame(a)})}var k=async e=>{let t=document.querySelector(e.selectors.contentImageSelector),o=40,n=0;for(;!t&&(await N(100),t=document.querySelector(e.selectors.contentImageSelector),n++,!(n>=o)););};var he=25,O=new Map,A=new Map,$=!1,U=!1,Ee=async(e,t=!0,o)=>(O.set(0,M(e).index),{getContent:async({index:n,abortSignal:a})=>{if(a.aborted)return{content:[],chunksAfter:0,chunksBefore:0};if(A.has(n))return A.get(n);o("processing"),await k(e);let r=G(e);if(!O.get(n)){$=!0,U=!0;let m=Array.from(O.keys()).at(-1),y=Math.abs(n-m);for(let d=0;d<y;d++)await Q(e);r=G(e),O.set(n,r.pageIndex);for(let d=0;d<y;d++)await Y(e);$=!1,U=!1}let i=await oe(r.content,r.top,r.left);return A.set(n,{content:i.map(m=>({...m,chunkIndex:n,chunkImageURL:r.imageUrl,locaionType:r.pageType,location:r.pageIndex})),chunksAfter:r.pageIndex===r.totalPages||!r.isRightChevronVisible?0:1,chunksBefore:r.pageIndex===1||r.isLeftChevronVisible?0:1}),o("complete"),A.get(n)},converter:n=>({text:n.text,ref:new ce.ObjectRef({ref:n})}),options:{autoplay:t,sideEffects:!0},metadata:{source:"KindleNudge"}}),le=async(e,t,o,n=!0)=>{let a=()=>K.getPlayingState()==="playing",r=async()=>B.registerHook("PROGRESSED",async s=>{if($)return;let g=s.cursor?.getParentElement().ref?.value?.ref;if(!g)return;let b=g.chunkImageURL;if(!b)return;let I=g.location,x=g.locaionType,f=C(e),S=M(e).index,H=M(e).type,z=0;if(f===b)return;let X=x!==H;if(Math.abs(I-S)>2&&!X){o(a());return}let de=I>S||X?Q:Y;for(U=!0;f!==b&&z<5;)await de(e),f=C(e),z++;U=!1}),c=async(s=!0)=>{let u=await Ee(e,s,t);J(u,!0);let g=await r();return()=>{A.clear(),O.clear(),g(),B.pause()}},i=await c(n),m=async s=>{i(),await N(he);let u=s===!0||!!a();i=await c(u)},y=(0,ie.throttle)(m,1e3),d=async s=>{W(s)||s.target instanceof HTMLElement&&s.target.closest("div.pagination-container")&&!s.target.closest("div.pagination-container")?.isSameNode(s.target)&&m()},E=async s=>{W(s)||(s.key==="ArrowRight"||s.key==="ArrowLeft")&&m()},h=()=>{let s=g=>{for(let b of g)if(b.type==="childList"){let I=Array.from(b.addedNodes);for(let x of I)x.id===e.selectors.scrubberId&&L(x)}},u=new MutationObserver(s);return u.observe(document.body,{childList:!0,subtree:!0}),()=>{u?.disconnect(),u=null}},p=null,w=()=>{p&&(p.disconnect(),p=null)},L=s=>{let u=g=>{for(let b of g)if(b.type==="attributes"&&b.attributeName==="value"&&!U){let I=!!a();y(I)}};w(),p=new MutationObserver(u),p.observe(s,{attributes:!0,attributeFilter:["value"]})};document.addEventListener("click",d),document.addEventListener("keydown",E);let F=h();return()=>{i(),F(),w(),document.removeEventListener("click",d),document.removeEventListener("keydown",E)}};function ue({config:e,wrapper:t}){let[o,n]=(0,l.useState)(!1),[a,r]=(0,l.useState)(!1),[c,i]=(0,l.useState)(!1),[m,y]=(0,l.useState)(!0),{usePlayingState:d}=K,E=d(),h=(0,l.useRef)(),p=E==="playing",w=E==="buffering",L=E==="errored",F=(0,l.useCallback)(f=>{i(f==="processing")},[]),s=(0,l.useCallback)(f=>{B.pause(),h.current&&h.current(),i(!1),n(!1),setTimeout(()=>{u(f)},250)},[]),u=(0,l.useCallback)(async(f=!0)=>{let S=await le(e,F,s,f);h.current=S},[]);(0,l.useEffect)(()=>{let f=async H=>{j(H,f),i(!0),n(!0),u()};return(async()=>{Z(f,["browser-action"],"pill-player"),await k(e),r(!0)})(),()=>{h.current&&h.current()}},[]),(0,l.useEffect)(()=>{(L||p)&&(i(!1),y(!1))},[L,p]);let g=(0,l.useMemo)(()=>ee({key:"player-emotion-cache",container:t}),[t]),b=(0,l.useCallback)(()=>{if(!o){i(!0),n(!0),u();return}c&&(i(!1),n(!1))},[o,c]),I=(0,l.useCallback)(()=>{y(!1)},[]),x=(0,l.useMemo)(()=>!a||c?!0:!o||L?!1:w,[o,w,a,L,c]);return preactH(te,{value:g},m&&preactH(ne,{onClick:b,onExit:I,root:t,isPlaying:p,isLoading:x,isLoadingFailed:L}))}var T,Ie="speechify-kindle-nudge",me="speechify-kindle-nudge-root";async function Pe(e){return await k(e),ve(e),()=>{we()}}async function ve(e){if(!T){let o=document.createElement("div");o.id=Ie,o.style.cssText="position: absolute; top: 0; right: 0;",document.body.appendChild(o),T=o.attachShadow({mode:"open",delegatesFocus:!0})}let t=document.createElement("div");t.id=me,t.tabIndex=-1,t.style.cssText="position: fixed; z-index: 2000; top: 80px; left: 130px;",T.appendChild(t),V(preactH(ue,{wrapper:t,config:e}),t)}var we=()=>{if(!T)return;let e=T.querySelector(`#${me}`);e&&(V(null,e),T.removeChild(e))};export{Pe as default,we as destroyKindleNudgePlayer};
//# sourceMappingURL=init-PYEGSUIK.js.map
