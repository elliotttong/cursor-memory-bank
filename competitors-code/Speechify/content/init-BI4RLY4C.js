import{e as se,f as ie,h as le,i as ce}from"./chunk-WSODYGO2.js";import"./chunk-7D3ZJIMI.js";import{b as re}from"./chunk-Z4JSAUZD.js";import"./chunk-M5NV5XMO.js";import"./chunk-PBN5LLAA.js";import"./chunk-MADPDA6U.js";import"./chunk-FEYPXFJ6.js";import"./chunk-BVP7ZEFD.js";import"./chunk-FJMP4XPS.js";import"./chunk-BRU4RAVQ.js";import"./chunk-QEP7SRH7.js";import"./chunk-OFYWCEWM.js";import"./chunk-TVWAVI6A.js";import"./chunk-CVF2X5Y4.js";import"./chunk-BD5GYQVX.js";import"./chunk-LBZ34ZL2.js";import"./chunk-SI7CO4VP.js";import"./chunk-JAWPO7FD.js";import"./chunk-N3ET5YJZ.js";import"./chunk-LXDXREIX.js";import"./chunk-MQX2TL35.js";import"./chunk-SWWFND36.js";import"./chunk-PJRECGUK.js";import{$a as A,Ec as te,M as G,Q as U,R as j,Vc as ne,Wc as oe,_a as O,cb as ee,ha as J,ib as Te,ma as D,na as R,oa as F,qa as Z,ra as $}from"./chunk-6VFX2JNU.js";import{k as we}from"./chunk-LUKOAFYK.js";import{L as H,M as z,i as _}from"./chunk-O77QQVYU.js";import"./chunk-35EEQS33.js";import"./chunk-BGIN6QNH.js";import"./chunk-UQBFOPQH.js";import"./chunk-6HLOLWYC.js";import"./chunk-XFWXZVUM.js";import"./chunk-D2ACMGPV.js";import"./chunk-NORECDYR.js";import"./chunk-RQERJHUS.js";import{d as q,h as B,o as x}from"./chunk-NUN3A7RC.js";x();B();var E=q(we());x();B();var Ce=q(Te());function ae(s,o){let d=document.elementsFromPoint(s,o).slice(0,3),c=[...d.filter(i=>i.shadowRoot).flatMap(i=>i.shadowRoot.elementsFromPoint(s,o).slice(0,3)),...d];return d.forEach(i=>{i.childNodes.forEach(w=>{if(w.nodeType===Node.TEXT_NODE){let C=w,S=document.createRange();S.selectNodeContents(C);let p=S.getBoundingClientRect();s>=p.left&&s<=p.right&&o>=p.top&&o<=p.bottom&&c.unshift(C)}})}),c}function M(s){return s?.replaceAll(/(?<!\n)\n(?!\n)/g," ")||""}function de(s,o){o=o.endsWith(".")?o.slice(0,-1):o;let t=M(s.textContent).indexOf(o);if(t===-1)return[];let c=t+o.length,i=$(s,t,c);return Array.from(i.getClientRects())}function ue(s,o){let d=L(s),t=L(o instanceof Element?o:o.parentElement);return!d||!t?!1:!(d.top>t.bottom||d.right<t.left||d.bottom<t.top||d.left>t.right)}function L(s){if(!s)return null;if(s.nodeType===Node.ELEMENT_NODE)return s.getBoundingClientRect();if(s.nodeType===Node.TEXT_NODE){let o=document.createRange();return o.selectNode(s),o.getBoundingClientRect()}return null}var{removeHighlights:Se,highlightElement:ke}=Z("speechifyClickToPlay",{sentenceOnly:!0,highlightColor:{sentence:{light:"rgba(255, 200, 100, 0.7)",dark:"rgba(204, 160, 80, 0.7)"},word:{light:"rgba(255, 200, 100, 0.7)",dark:"rgba(204, 160, 80, 0.7)"}}});async function ye(s={}){if(s?.disabled)return;let{CursorQueryBuilder:o,SpeechQueryBuilder:d}=await J(),t={enabled:!0,blocks:[],hoveredElement:null,hoveredCursorPosition:null},c={element:null,sentenceBounds:[]},i={isDynamicStandardView:!1,speechView:null,standardBlocks:[]},w=null,{clickToListen:C}=await U(),S=await R("clickToListen"),p=await F("clickToListen");function me(e){if(!e||!(e instanceof Element))return!1;let r=e.getBoundingClientRect();if(r.bottom<0||r.right<0||r.top>window.innerHeight||r.left>window.innerWidth)return!1;let u=r.left+r.width/2,a=r.top+r.height/2,n=document.elementFromPoint(u,a);return n===e||e.contains(n)}t.enabled=C&&!S||p;let V=await se("click-to-listen-hints"),K=G.on("update",async({clickToListen:e})=>{let r=await R("clickToListen"),u=await F("clickToListen");t.enabled=e&&!r||u}),v=()=>{let e=c.element?.getRootNode();c.element=null,c.sentenceBounds=[],Se(e instanceof ShadowRoot?e:void 0),V&&ie("click-to-listen-hints")},fe=async(e,r)=>{let u=o.fromCursor(r.start),a=o.fromCursor(r.end),n=d.fromBounds(u,a),l=await H(e.getSpeech.bind(e))(n);return _(l,()=>({sentences:[]})).sentences.map(m=>m.text.text)},b=async(e=!0)=>{i.standardBlocks.filter(n=>{let l=n.start.getParentElement().ref.value?.ref;return!D(l)&&l&&!l.isConnected}).length>0&&await N();let u=i.standardBlocks;return await z(u,async n=>{let l=n.start.getParentElement().ref.value?.ref;if(D(l)||!l||!l.isConnected)return[];let f=L(l);if(e&&f&&!(f.top>0&&f.top<=window.innerHeight))return[];let m=(0,E.get)(n,"text.text")||"";if(!i.speechView)return[];let h=await fe(i.speechView,n);return[{start:n.start,sentences:h??[],text:m}]})},N=async()=>{let{bundle:e}=A.getBundleState();if(!e)return;let r=e?.listeningBundle.contentBundle.standardView;i.isDynamicStandardView=!1,i.standardBlocks=[],i.speechView=e.listeningBundle.contentBundle.speechView;let u=await H(r.getBlocksBetweenCursors.bind(r))(r.start,r.end),a=_(u,()=>({blocks:[]})).blocks;i.isDynamicStandardView=!1,i.standardBlocks=a,i.speechView=e.listeningBundle.contentBundle.speechView},ge=await ee("PLAYABLE_CONTENT_UPDATED",async()=>{await N(),t.blocks=await b()}),pe=e=>{t.hoveredCursorPosition&&(O.seekToCursor(t.hoveredCursorPosition),j(!0),e.preventDefault(),e.stopPropagation(),ne("click-to-listen-hints"),te())},X=()=>{window.addEventListener("pointerup",e=>{(window.getSelection()??"").toString().length>0||pe(e)},{once:!0,capture:!0})},I=(0,E.throttle)(e=>{let r=re.get().route;if(!t.enabled||r.indexOf("settings")!==-1){v();return}t.hoveredCursorPosition=null,t.hoveredElement&&(t.hoveredElement.style.cursor="default",t.hoveredElement.title="",t.hoveredElement=null),c.element=null,c.sentenceBounds=[];let u=ae(e.clientX,e.clientY).slice(0,5),a=t.blocks.find(k=>{let y=k?.text;if(!y)return!1;let T=u.find(g=>g?.textContent===y);return!T||T.textContent===null?!1:y.includes(T.textContent)||ue(k.start.getParentElement().ref.value.ref,T)});if(!a)return;let n=a.start.getParentElement()?.ref.value.ref;if(!n||!me(n)||(n instanceof Element?n:n.parentElement)?.closest("a"))return;let l=a.sentences.findIndex(k=>!!de(n,k).find(g=>e.clientX>g.x-4&&e.clientX<g.x+g.width+4&&e.clientY>g.y-4&&e.clientY<g.y+g.height+4));if(l===-1)return;l===0?t.hoveredCursorPosition=o.fromCursor(a.start):t.hoveredCursorPosition=o.fromCursor(a.start).scanForwardToSentenceStart(l-1);let f=a.sentences[l],m=M(n.textContent),h=m.indexOf(f);h===-1&&(h=m.indexOf(f.slice(0,-1)));let Ee=Math.min(m.length,h+f.length);n.nodeType===3?(n.parentElement.style.cursor="pointer",t.hoveredElement=n.parentElement):(n.style.cursor="pointer",t.hoveredElement=n),c.element=n,c.sentenceBounds=[h,Ee],t.hoveredElement?.addEventListener("mouseleave",v,{once:!0})},32),Y=(0,E.debounce)(async()=>{t.blocks=await b()},32),Q=()=>{if(c.element){let{element:e,sentenceBounds:r}=c,a=e.nodeType===Node.TEXT_NODE?[e.parentNode]:[e],n=r,l=[0,0],f=i.standardBlocks[0]?.start?.getParentElement().ref?.value?.highlightInfo?.unsetColor;try{let{lineRect:m}=ke(e,a,n,l,{unsetColor:f})??{};V&&m&&(ce({hintId:"click-to-listen-hints",anchorElement:null,text:"Click any sentence to jump and listen from it.",xOffset:m.x+25,yOffset:m.y+5,closable:!1}),le("click-to-listen-hints"))}catch{}}w=requestAnimationFrame(Q)},P=!1,W=()=>{let e=A.getPlayingState();e==="playing"||e==="buffering"?(Q(),P||(window.addEventListener("mousemove",I),P=!0),oe("still-listening")):(cancelAnimationFrame(w??0),P=!1,v(),window.removeEventListener("mousemove",I))},he=await O.registerHook("PLAYBACK_STATE_CHANGED",async()=>{W()});return W(),window.addEventListener("scroll",Y,{capture:!0}),window.addEventListener("pointerdown",X,{capture:!0}),await N(),t.blocks=await b(),()=>{window.removeEventListener("scroll",Y,{capture:!0}),window.removeEventListener("pointerdown",X,{capture:!0}),window.removeEventListener("mousemove",I),K(),he(),ge(),K()}}export{ye as default};
//# sourceMappingURL=init-BI4RLY4C.js.map
