import{$a as a,Va as B,Ya as b,Za as q,_a as g,_b as y,ab as h,bb as P,cb as F,ha as O,ja as I,jb as G,va as k}from"./chunk-6VFX2JNU.js";import{L as M,i as L}from"./chunk-O77QQVYU.js";import{i as H}from"./chunk-BGIN6QNH.js";import{d as v,h as m,o as p}from"./chunk-NUN3A7RC.js";p();m();p();m();var C=v(H());function Q(e){let t=[(e||[])[0]];for(let n of e.slice(1)||[])n&&t.every(r=>!r.contains(n))&&(t=[...t.filter(r=>!n.contains(r)),n]);return t}function J(e){let t=document.createRange();if(!e.anchorNode||!e.focusNode)return!1;t.setStart(e.anchorNode,e.anchorOffset),t.setEnd(e.focusNode,e.focusOffset);let n=t.collapsed;return t.detach(),n}function D(){let e=window.getSelection();if(!e||e.isCollapsed)return;let t=J(e),n=e.focusNode;if(!n)return;let r=e.focusOffset;e.collapse(e.anchorNode,e.anchorOffset);let o=[];t?o.push("backward","forward"):o.push("forward","backward"),e.modify("move",o[0],"character"),e.modify("move",o[0],"character"),e.modify("move",o[1],"word"),e.extend(n,r),e.modify("extend",o[1],"character"),e.modify("extend",o[1],"character"),e.modify("extend",o[0],"word")}var X=e=>Array.from(e.querySelectorAll("div.kix-canvas-tile-content.kix-canvas-tile-selection > svg")),S=()=>X(document.body).find(n=>n.hasChildNodes()),x=(e,t)=>{let n=e.x-16<=t.x&&e.x+e.width+16>=t.x+t.width,r=e.y-16<=t.y&&e.y+e.height+16>=t.y+t.height;return n&&r},W=async e=>({getContent:await P(async()=>({content:e,chunksBefore:0,chunksAfter:0})),converter:t=>({text:Array.from(t.querySelectorAll("rect")).map(o=>o.getAttribute("aria-label")).join(" "),ref:new C.ObjectRef({ref:t})}),options:{sideEffects:!1,autoplay:!1},metadata:{source:"Selection Player"}}),_=async e=>{let{ObjectRef:t}=await O(),n=e.getRangeAt(0),r=Q(k(n)).filter(o=>!(o instanceof Element&&G.includes(o.tagName)));if(r.length===0)throw new Error("No elements found");return{getContent:await P(async()=>({content:r,chunksBefore:0,chunksAfter:0})),converter:o=>{let s=o instanceof Node&&o.isSameNode(n.startContainer)?n.startOffset:0;return{text:o instanceof Node?o.textContent?.slice(o.isSameNode(n.startContainer)?n.startOffset:0,o.isSameNode(n.endContainer)?n.endOffset:void 0)??"":"",ref:new t({ref:o,highlightInfo:{startOffset:s}})}},options:{sideEffects:!1,autoplay:!0},metadata:{source:"Selection Player"}}},j=async e=>{let{bundle:t}=a.getBundleState();if(!t)return null;let n=Q(k(e));if(n.length===0)throw new Error("No elements found");let r=t.listeningBundle.contentBundle.standardView,o=await M(r.getBlocksBetweenCursors.bind(r))(r.start,r.end),s=L(o,()=>({blocks:[]})).blocks,c=n.at(-1),u=s.find(l=>{let d=l.start.getParentElement().ref.value.ref;return d.nodeType===3&&(d=d.parentElement),d.contains(c)});if(u){let l=u.start.getParentElement().ref.value.ref,d=Array.from(l.childNodes).findIndex(T=>T===c),Y=Array.from(l.childNodes).slice(0,d).reduce((T,V)=>(V?.textContent?.length||0)+T,0)+e.endOffset,K=C.CursorQueryBuilder.fromCursor(u.start).scanCharsForward(Y);t?.listeningBundle.audioController.seek(K)}};var U=v(H()),i=null,w=null,R=null,f=!1,E=null,$="speechify-pill-player",ee="speechify-embedded-player",te="speechify-screenshot-mode",ne=e=>!!e.attributes?.getNamedItem("data-speechify-shadow-container"),oe=e=>!($===e.id||document.getElementById(ee)?.contains(e)||document.getElementById(te)?.contains(e)||ne(e)),re=()=>{let e=S();if(!e)return;let n=Array.from(e.querySelectorAll("rect:not(clipPath rect)")).map(r=>{let o=r.getBoundingClientRect(),s=b(r);return(s?B(s):[]).find(l=>x(o,l.getBoundingClientRect())||x(l.getBoundingClientRect(),o))}).filter(Boolean);return n.filter((r,o)=>n.indexOf(r)===o)},se=async()=>{let e=S();if(!e)return;let t=Array.from(e.querySelectorAll("rect:not(clipPath rect)"))[0],n=t.getBoundingClientRect(),r=b(t),s=(r?B(r):[]).find(u=>x(u.getBoundingClientRect(),n)),{bundle:c}=a.getBundleState();!s||!c||q(c,s)},A=async e=>{if(i){(window.getSelection()??"").toString().length>0&&window.getSelection()?.empty(),i.options&&(i.options.autoplay=!1),e&&(i.metadata.source="Selection Player"),h(i,!0);let t=await F("PLAYABLE_CONTENT_UPDATED",async()=>{E!==null&&(g.seekToCursor(U.CursorQueryBuilder.fromCursor(E)),E=null),t()});i=null}},N=async(e=!1)=>{if(y()){if(i||(i=a.getBundleState().currentContent),!e)se(),f=!0;else{let r=re();if(r?.length){let o=await W(r);h(o,!0)}}return}let t=window.getSelection();if(!t||t.isCollapsed||!t.rangeCount)return;e||(D(),f=!0),i||(i=a.getBundleState().currentContent),w=t.getRangeAt(0);let n=await _(t);n.options&&(n.options.autoplay=!e),h(n,!0),e||t.collapseToEnd()},ae=async()=>{f&&(f=!1,y()?A():R?N(!0):w&&(A(!0),await I(200),j(w)))},z=async()=>{a.getPlayingState()==="playing"?f&&(R=window.getSelection()):(y()?!!S():(window.getSelection()??"").toString().length>0)?N(!0):(E=a.getBundleState().cursor,R=null,w=null,A())};async function ie(){let e=g.registerHook("BEFORE_PLAY",async()=>{a.getBundleState().currentContent?.metadata?.source==="Selection Player"&&N()}),t=async()=>{a.getPlayingState()==="ended"&&ae()},n=g.registerHook("PLAYBACK_STATE_CHANGED",t),r=()=>{requestAnimationFrame(()=>{z()})},o=()=>{window.addEventListener("pointerup",s=>{oe(s.target)&&requestAnimationFrame(()=>{z()})},{once:!0,capture:!0})};return window.addEventListener("pointerdown",o,{capture:!0}),window.addEventListener("contextmenu",r,{capture:!0}),()=>{e(),n(),window.removeEventListener("pointerdown",o,{capture:!0}),window.removeEventListener("contextmenu",r,{capture:!0})}}export{A as a,N as b,ie as c};
//# sourceMappingURL=chunk-BD5GYQVX.js.map
